# 选链机制

David adds: 
In the swarm, when peers send out (n+1)th blocks, the highest difficulty n-th block will win. However, when this blockchain's fork block happens prior to mutable range, it will send to human intervention for now. In the future, we will adopt voting system, which could be onchain id basis, pot power basis or pos power basis.

A normal node is the one continously online for more than 12 hours. Other than this, it is defined as new node.
正常节点的定义：任何节点只有连续在swarm中接受n+1区块12小时，才是正常节点。除此之外就定义为新节点。新节点的选链状态一直是在随机行走中的。 For new nodes, there is not mutable range, until it is online for 12 hours.

“最长链的切换“策略。在tau swarm peers中对n+1个区块进行表决时，接受节点A会收到许多P1，P2，P3...等的n+1区块的表决，这些区块的第n区块都有个积累难度值。含有第n区块的链的分叉点在12小时的mutable range内，难度值最大的第n区块b1将获得信任，含区块b1的区块链即便是一票也可以获得胜利，本质上是在swarm里面随机行走。但是区块链的位置分叉点落在mutable range 12小时切分点之前，b1将不会被切换，而转给人工处理。

Taixiang:

先理解一下投票的本质，投票应该是一种从可能存在的多条链中，选择出最被社区拥护的链的便捷途径，这条链不一定累计难度值更大，因为完全可能存在一条伪造的、难度值更大，也符合POT共识的私有链。投票的首要任务就是排除一些伪造但又合法的链，把真正的社区链给挑选出来。如果节点还愿意进一步验证这条链，完全可以从创世区块开始把链从头到尾验证一边，以确保万无一失；如果投票的过程具有社区代表性，比如投票的节点一直是比较信赖的社区节点或者按照随机原则从社区挑选的，则完全可以跳过全验证，直接接着这条链往前走。同时，还要明白：社区链可能一直在切换中，因为对于一个矿工新出的区块，其它的矿工可能还想试图自己出块代替，但是经过社区其它矿工几个回合的出块，链在这个高度会随着链的增长逐渐收敛到一个区块上面（我们认为在12个小时会成功收敛，或者说mutable range=144），因此社区链的共识度越接近最新区块也越高，这就使得投票投出的链只是部分链，是社区链的共识度最高的那一部分，也即是社区链12小时之前（或者说接近mutable range）的那部分链。

具体的投票行为为：节点向连接的swarm节点请求n+1区块，收到cid1,cid2,cid3等表决，这些cid为当前链最新区块的cid，通过这些cid可以回溯12个小时的区块，这些区块的cid可以看作某个高度的候选人，也即是每个节点可以在12个小时高度以内的高度上都推荐候选人，如果链是收敛的，那么在12个小时之内的高度内，一定能找到一个被推荐次数达到要求（比如过2/3票数）的候选人，也即区块cid，这也即意味着投票成功。但这个区块的cid可能离最新区块还有一定的距离，后面的距离就需要一个个区块验证过去。不用担心有些节点会投出n+2或者n+3甚至更高位置的票，由于我们相信社区绝大多数的节点行为是正确的，这些少部分的链要么有问题，要么出现的晚。如果那些票没问题，只是可能被发现的晚，那么我们跟着大多数节点进行同步完，也自然会随着大多数节点切换到这些链上，并不耽误，如果有问题，票少自然也选不上，因此不用特意处理。

因此，一个节点（不区分是否新节点）上线之后，都会先挑选具有社区代表性的节点进行一次投票，如果链是收敛的，最差的结果也应该在社区链的12小时之前的高度（或者说mutable range之外）有足够的共识，对于选出的链来说，会和本地的链进行一次寻找共同区块（也即是分叉点）的过程，这个共同区块也即是链切过去需要回滚的终点，如果切换回滚的高度超过12小时的距离，则给出提示让用户介入选择，否则直接切过去同步社区链。如果投票失败，可能是节点挑选的问题，也可能是链本身不收敛，则同样让用户选择。（暂不考虑本地链切换到投票的链，需要回滚12个小时区块的情况）

投票选择的链可能不是最新的链，但也应在12小时之内，等同步进入12小时之内就可以一个个区块验证过去，正确选择出一个难度值最大的链。



## 节点pub的内容

理论上，节点之间只用pubsub两个topic就可以处理完成区块（包括链的投票、同步、新区块的同步）和交易（包括现存交易池的同步、新交易的同步）相关的信息交换。区块的topic是每个节点定时pub自己本地的一个root cid，该root cid连接到144个最新高度的区块，这里以mutable range=7为例说明；交易的topic也是每个节点定时pub自己本地的一个root cid，该root cid连接到一定数量的最高交易费的交易，比如前500笔交易费的交易，有了该root cid，其它节点可以按需下载一定数量的交易。由于所有之前获取过的内容，第二次获取会优先从本地拿，所以也不用担心重复带来的流量问题。

![blockrootcid]( https://github.com/Tau-Coin/taucoin-ipfs-docs/blob/master/imgfile/blockrootcid.jpg )  

![txrootcid]( https://github.com/Tau-Coin/taucoin-ipfs-docs/blob/master/imgfile/txrootcid.jpg )    

## 选链

### 同步阶段

一般新节点上线，会经过两个同步阶段：

投票同步阶段：这个阶段主要针对于新上线的节点或者之前同步过少部分区块的节点，本地区块高度距离社区最长链高度144个区块之外，由于需要同步mutable range之外的区块，因此需要慎重投票，在某个高度选出一个票数最多的区块，然后回溯同步。由于同步时间问题，回溯同步完成之后社区链可能又增长了不少，因此上述过程可能需要投票迭代多次，直至本地区块高度同步至所发现的社区最长链的144高度差以内，并进入下一阶段同步过程；

快速同步阶段：这个阶段主要针对本地区块高度低于发现的最长链高度144个区块之内的情况，这时需要同步的区块在mutable range之内，因此无需投票，可以快速同步。

### 实施步骤

![voting]( https://github.com/Tau-Coin/taucoin-ipfs-docs/blob/master/imgfile/voting.jpg )  

\1. 初始化，并进入节点发现阶段，发现到m个peer或者尝试足够的时间，结束节点发现阶段;

\2. 从m个peer中可以按照一定标准（比如历史行为信任度、peer id的矢量距离等条件），挑选出具有可信度和随机性的节点n个，以n=5为例;

\3. 收集这5个peer所pub的cid，并get解析出其对应的7个区块，出错或异常则转入1;

\4. 获取本地区块高度H1，从5个peer sub到的最大区块高度记为H2，比较H1和H2，如果H1>=H2，转到9；如果H2-H1>144，转到6;

\5. 挑选最长链最高高度H2对应的区块作为best block，转到8;

\6. 由height从高到低，选出得票数最多的区块的cid，比如图中k+1高度有5票最高票，获取其对应的区块作为best block，转到8;

\7. 分叉点超出mutable range异常，请求用户从社区获取当前最高的区块cid，获取对应的区块作为best block;

\8. 从best block回溯区块链并验证，出错或异常转到1，否则转到3;

\9. 开始挖矿。

#### 投票节点挑选方法

目前只有历史上有过挖矿记录的节点才可以投票；

以下方式暂不考虑：

基于Weak Subjectivity思想，挑选节点可以引入社区关系，同时与随机性相结合，挑选方法为：

1. 根据历史行为信用评分排名挑选，优先挑选信用评分高的，其中，白名单节点信用评分>0，陌生节点信用评分=0，黑名单节点信用评分<0；
2. 同信用评分情况下，比如都是陌生节点这种情况，根据与peer id的矢量距离远近挑选，要求矢量距离要满足一定的标准；
3. 同时，可以灵活根据评分等因素赋予每个节点的投票以相应的权重因子，信任节点与矢量距离近的节点也可以有一个固定的比例。
